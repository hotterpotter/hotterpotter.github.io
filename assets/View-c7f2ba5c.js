import{c as dt,d as V,B,g as ut,e as Y,p as Z,b as ht}from"./empty-b0006653.js";import{_ as tt,o as l,e as u,q as _,j as A,p,A as ft,bL as st,bM as pt,t as yt,W as Q,s as h,F as q,h as it,k as O,bN as j,bO as E,bP as gt,bQ as C,a as T,x as R,C as rt,y as wt,B as mt,bR as _t,r as I,b as St,c as G,w as P,d as bt,f as U}from"./index-e26bbf42.js";import{a as F,c as At,s as D,f as M,d as at,h as ot,i as N,r as xt,e as k,j as It}from"./price-501e284c.js";import{a as J,d as X,b as vt}from"./db-96a23545.js";import{W as et,O as ct}from"./Wif-c52e7263.js";const Bt={props:["url"],data(){return{fileType:"",data:""}},mounted(){this.init()},watch:{url(){this.init()}},methods:{async init(){if(!this.url){this.data="",this.fileType="";return}const{pathname:t}=new URL(this.url),i=t.slice(t.lastIndexOf("/")+1);if(["mp4","webm","ogg"].includes(i.split(".").pop()?.toLowerCase()))this.fileType="VIDIO",this.data=this.url;else if(["jpg","jpeg","webp","gif","png","bmp"].includes(i.split(".").pop()?.toLowerCase()))this.fileType="IMAGE",this.data=this.url;else{this.fileType="TEXT";const a=await fetch(this.url).then(o=>o.text());this.data=a}}}},Ct={style:{height:"300px","text-align":"center"}},Tt={key:0},Pt={key:1,style:{"max-height":"300px","max-width":"100%"},id:"mainPlayer",autoplay:"",controls:""},Ut=["src"],kt=["src"],Nt={key:3,style:{"max-height":"300px","max-width":"100%"}};function Dt(t,i,a,o,e,n){return l(),u("div",Ct,[e.fileType?_("",!0):(l(),u("div",Tt,"loading")),e.fileType==="VIDIO"?(l(),u("video",Pt,[A("source",{src:e.data},null,8,Ut)])):_("",!0),e.fileType==="IMAGE"?(l(),u("img",{key:2,style:{"max-height":"300px","max-width":"100%"},src:e.data},null,8,kt)):_("",!0),e.fileType==="TEXT"?(l(),u("div",Nt,p(e.data),1)):_("",!0)])}const Ht=tt(Bt,[["render",Dt]]);function H(t,i){const a=dt.clone();a.config({EXPONENTIAL_AT:[-30,30]});let o="",e="";const n=t.toString().split(".");return n[1]?(e=new a(`0.${n[1]}`).sd(i,a.ROUND_HALF_UP).toString(),e==="1"?o+=new a(`${n[0]}`).plus(new a(`${e}`)).toFixed():o+=`${n[0]}.${e.split("0.")[1]}`,o):t.toString()}function W(t){return B(t).div(Q.toString()).toString()}async function Ot(t,i,a,o){const e=await F(t,i,!1),n=await e.getSeriesInfo(o),{_holdingScoreCoefficients:s,_holdingTokens:r,_paymentScoreCoefficients:c,_paymentTokens:d}=await e.getScoreCoefficients(),f=["function symbol() view returns (string)","function balanceOf(address account) external view returns (uint256)","function decimals() view returns (uint8)"],y=await Promise.all(r.map(b=>b===ft?{balanceOf(S){return st().getBalance(S)},symbol(){return i===1e4?"BCH":"BNB"},decimals(){return 18}}:pt(b,f,i,!1))),m=await Promise.all(y.map(b=>b.symbol())),g=await Promise.all(y.map(b=>b.balanceOf(a))),w=await Promise.all(y.map(b=>b.decimals())),x=await e.getSeriesScore(a,o),L=x.gte(n.requiredScore),$=r.map((b,S)=>({token:r[S],symbol:m[S],userScoreCoefficient:H(W(g[S].mul(s[S]).div(V("1",w[S])).toString()),2),userBalance:H(B(g[S].toString()).div(V("1",w[S]).toString()).toString(),2),needAmount:L?0:H(W(n.requiredScore.sub(x).mul(V("1",18)).div(s[S]).toString()),2)})),z=await At();return{tokens:$,seriesInfo:{description:yt(n.description),requiredScore:W(n.requiredScore.toString())},totalScore:H(W(x.toString()),2),usdPrice:z}}async function K(t,i,a,o){const e=await F(t,i,!1);let n=await e.getSeriesScore(a,o);const s=await e.getSeriesInfo(o);return n.gte(s.requiredScore)}const Ft={props:["file"],data(){return{scoresInfo:null,filePrice:null,enoughScore:null,store:h}},methods:{async init(){if(!this.file){this.scoresInfo=null,this.filePrice=0,this.enoughScore=null;return}const{seriesId:t}=D(this.file.fileid);this.scoresInfo=await Ot(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,h.account,t),this.enoughScore=await K(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,h.account,t),this.filePrice=ut(await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid))},toPrecision_(t){return H(t,2)}},watch:{file(){this.init()},"store.account"(){this.scoresInfo=null,this.filePrice=null,this.enoughScore=null,this.init()}}},Et={key:0,style:{margin:"20px"}},Rt={style:{"margin-top":"20px"}},Wt={style:{"margin-top":"20px"}},Mt=A("br",null,null,-1),Lt={style:{"margin-top":"20px"}},$t={key:0},zt={key:0,style:{"margin-top":"20px"}},Vt={key:1};function qt(t,i,a,o,e,n){return l(),u(q,null,[e.scoresInfo?(l(),u("div",Et,[A("div",Rt,' This file is in the series "'+p(e.scoresInfo.seriesInfo.description)+'" and requires '+p(e.scoresInfo.seriesInfo.requiredScore)+" score to play. ",1),A("div",Wt,[(l(!0),u(q,null,it(e.scoresInfo.tokens,(s,r)=>(l(),u("span",null,[O("You own "+p(s.userBalance)+" "+p(s.symbol)+" and get "+p(s.userScoreCoefficient)+" scores.",1),Mt]))),256))]),A("div",Lt,[O(" You get "+p(e.scoresInfo.totalScore)+" scores in total, which are "+p(e.enoughScore?"enough":"not enough")+" to view the files in this series for free. ",1),e.enoughScore?_("",!0):(l(),u("div",$t,[O(" You need get "),(l(!0),u(q,null,it(e.scoresInfo.tokens,(s,r)=>(l(),u("span",null,p(r!==0&&" or"||"")+" "+p(s.needAmount)+" "+p(s.symbol),1))),256))]))]),e.filePrice!=="0"?(l(),u("div",zt," To view this file, you need pay "+p(e.filePrice)+" BCH("+p(n.toPrecision_(e.filePrice*e.scoresInfo.usdPrice))+" usd) ",1)):_("",!0)])):_("",!0),e.scoresInfo?_("",!0):(l(),u("div",Vt," loading "))],64)}const jt=tt(Ft,[["render",qt]]);async function Gt(t,i,a,o,e,n){window.WifAndAddr||await window.GetWIF(t);const s=await et.fromWIF(window.WifAndAddr[0]),r=window.WifAndAddr[1],c=bchaddr.toCashAddress(i),d=t.utils.arrayify(a),f=t.utils.arrayify(o),y=t.utils.arrayify(r),m=t.utils.arrayify(e),g=lt([Uint8Array.of(106),Uint8Array.of(4,69,71,84,88),Uint8Array.of(f.length),f,Uint8Array.of(y.length),y,Uint8Array.of(d.length),d,Uint8Array.of(m.length),m]);console.log("opReturnU8A:",g);const w=ct.fromBuffer(g);return console.log("opRet:",w),await s.send([w,{cashaddr:c,value:n,unit:"sat"}])}async function Jt(t,i,a,o,e,n){window.WifAndAddr||await window.GetWIF(t);const s=await et.fromWIF(window.WifAndAddr[0]),r=window.WifAndAddr[1],c=bchaddr.toCashAddress(i),d=t.utils.arrayify(a),f=t.utils.arrayify(o),y=t.utils.arrayify(r),m=t.utils.arrayify(e),g=lt([Uint8Array.of(106),Uint8Array.of(4,69,71,84,88),Uint8Array.of(f.length),f,Uint8Array.of(y.length),y,Uint8Array.of(d.length),d,Uint8Array.of(m.length),m,Uint8Array.of(0),Uint8Array.of(2,12,205)]);console.log("opReturnU8A:",g);const w=ct.fromBuffer(g);return console.log("opRet:",w),(await s.encodeTransaction([w,{cashaddr:c,value:n,unit:"sat"}])).encodedTransaction}function lt(t){let i=t.reduce((e,n)=>e+n.length,0);console.log(i);let a=new Uint8Array(i);if(!t.length)return a;let o=0;for(let e of t)a.set(e,o),o+=e.length;return a}async function nt(){window.WifAndAddr||await window.GetWIF(Y);let i=await(await et.fromWIF(window.WifAndAddr[0])).getBalance();return i=Z(i.bch.toString()),i.toString()}const v=await k.Sesstion.startSession(rt.coordinatorUrl),Xt={components:{Media:Ht,Scores:jt},data(){return{url:"",file:null,readme:null,homepage:"",payType:0,store:h}},async mounted(){try{await this.init(),await this.check()}catch(t){console.log(t)}},watch:{"store.account"(){window.WifAndAddr="",this.file&&(this.url="",this.payType=0,this.homepage="",this.check())}},methods:{async payByStochastic(){try{const t=j({duration:0,forbidClick:!0,message:"paying"}),{author:i}=this.readme,a=this.file.fileid,o=B(await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid)).multipliedBy(1e8).div(Q.toString()).integerValue(B.ROUND_CEIL).multipliedBy(20).toFixed(0);if(E.from(await nt()).lt(E.from(o).add(Z("0.0001"))))throw new Error("not enough balance");const s=await(await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1)).bchPayee(),r=at(s);let c=await Jt(Y,r,i,"0x56eb561cb6f98a985f80464fa99267a462c91bdb",a,o);c=gt.from(c).toString("hex");const d=await v.coordinator.getProxy("bchrelayer"),f=await fetch(`${d}/relay?tx=${c}`).then(S=>S.json());if(t.message="pay success",!f.success)throw new Error(f);const{logSig:y,rawLog:{topics:m,data:g,timestamp:w},vrfAlpha:x,prob16:L,rand16:$}=f.result,z=await ot(m,g,y,{ts:parseInt(w)}),b=N(a,3,z);await J(h.account,this.$route.params.cid,"STOCHASTIC",i,B(o).multipliedBy(1e10).toString(),parseInt(w)*1e3,$<L?x:"",this.readme.introduction,b),await this.downloadBySTOCHASTIC(),C()}catch(t){C(),T(t.message)}},async init(){try{const t=this.$route.params.cid;this.readme=JSON.parse(await v.getReadme(t));const a=(await v.getConfig(t)).files[0];this.file=a;const o=await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1);this.homepage=ht(await o.homepage())}catch(t){T(t.message)}},nav(){this.$router.push({name:"index"})},async downloadByMainChain(){const t=this.file.fileid,{author:i}=this.readme,a=new Headers;a.append("Content-Type","application/json");const o=JSON.stringify({jsonrpc:"2.0",method:"eth_getLogs",params:[{address:"0x56eb561cb6f98a985f80464fa99267a462c91bdb",fromBlock:"0x0",topics:[R(h.account,32),R(i,32),t]}],id:1}),e={method:"POST",headers:a,body:o},s=(await xt(rt.MAIN_CHAIN_RPCURL,e,10).then(w=>w.json())).result.pop().blockHash,r=[R(h.account,32),R(i,32),t],c=await v.coordinator.getProxy("bch"),d=await new k.Authorizer(c).getLog("0x56eb561cb6f98a985f80464fa99267a462c91bdb",s,r,10),f=`0x${k.base64ToHex(d.proof)}`,y=`0x${k.base64ToHex(d.result).slice(-640)}`,m=await ot(r,y,f),g=N(t,2,m);await this.download(g)},async pay(){try{const t=E.from(await nt()),i=E.from(D(this.file.fileid).priceInWei).add(Z("0.0001"));if(t.gte(i)){await this.payByMainChain();return}if((await(await st()).getBalance(h.account)).gte(i)){await this.payBySmartChain();return}throw new Error("not enough balance")}catch(t){console.error(t),T(t.message)}},async payByMainChain(){try{const t=j({duration:0,forbidClick:!0,message:"paying"}),{author:i}=this.readme,o=await(await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1)).bchPayee(),e=at(o),n=this.file.fileid,s=await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid),r=B(s).multipliedBy(1e8).div(Q.toString()).integerValue(B.ROUND_CEIL).toFixed(0),c=await Gt(Y,e,i,"0x56eb561cb6f98a985f80464fa99267a462c91bdb",n,r);await J(h.account,this.$route.params.cid,"MAIN_CHAIN",i,s,new Date().getTime(),c.txId,this.readme.introduction),t.message="pay success",await new Promise((d,f)=>setTimeout(()=>{d(0)},1e3)),t.message="downloading",await this.downloadByMainChain(),C()}catch(t){C(),T(t.message)}},async payBySmartChain(){try{const t=wt.find(c=>c.chainId===this.file.decryptionguides[0].chainid);await mt(t);const i=j({duration:0,forbidClick:!0,message:"paying"}),a=this.file.fileid,o=await _t(),{author:e}=this.readme,n=await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid),r=await(await o.sendTransaction({to:e,value:n,data:a})).wait();await J(h.account,this.$route.params.cid,"SMART_CHAIN",e,n,new Date().getTime(),r.transactionHash,this.readme.introduction),i.message="pay success",await new Promise((c,d)=>setTimeout(()=>{c(0)},1e3)),i.message="Waiting confirm",await new Promise((c,d)=>setTimeout(()=>{c(0)},50*1e3)),i.message="downloading",await this.downloadBySmartChain(),C()}catch(t){C(),T(t.message)}},async download(t){const i=this.$route.params.cid,a=await v.getConfig(i),o=a.files[0];this.url=await v.getDownloadUrl(i,o.filename,a,[t])},async downloadBySTOCHASTIC(){const t=await X.payments.where({account:h.account,cid:this.$route.params.cid,type:"STOCHASTIC"}).last();await this.download(t.calldata)},async downloadBySmartChain(){const t=this.$route.params.cid,a=(await v.getConfig(t)).files[0],o=a.fileid,e=await X.payments.get({account:h.account,cid:this.$route.params.cid}),{txId:n}=e,s=await new k.Authorizer(`https://${a.decryptionguides[0].authorizerlist[0]}`).getTx(n,30),r=`0x${k.base64ToHex(s.proof)}`,c=await It(this.file.decryptionguides[0].chainid,n,r),d=N(o,1,c);await this.download(d)},async check(){try{await vt(h.account,this.$route.params.cid,Date.now(),this.readme.introduction);const t=this.file,{author:i}=this.readme,a=t.fileid;let o;if(h.account===i)o=N(a,0,"0x"),this.download(o);else{const{price:e,stochasticEnabled:n}=D(a);if(e==="0")await K(t.decryptionguides[0].contract,t.decryptionguides[0].chainid,h.account,D(a).seriesId)&&(o=N(a,0,"0x"),this.download(o));else if(await K(t.decryptionguides[0].contract,t.decryptionguides[0].chainid,h.account,D(a).seriesId)){const r=await X.payments.where({account:h.account,cid:this.$route.params.cid}).last();if(!r){this.payType=n?2:1;return}if(r.type==="MAIN_CHAIN")await this.downloadByMainChain();else if(r.type==="SMART_CHAIN")await this.downloadBySmartChain();else{if(new Date().getTime()-r.timestamp>30*60*1e3){this.payType=n?2:1;return}await this.downloadBySTOCHASTIC()}}}}catch(t){T(t.message)}}}},Yt={style:{margin:"20px"}},Zt={key:0},Qt={key:1,style:{"word-wrap":"break-word"}},Kt={key:2};function te(t,i,a,o,e,n){const s=I("van-nav-bar"),r=I("Media"),c=I("van-tab"),d=I("van-button"),f=I("Scores"),y=I("van-tabs"),m=I("van-popup"),g=St("responsive-popup");return l(),G(m,{show:!0,position:"left",style:{width:"100%",height:"100%"}},{default:P(()=>[bt((l(),u("div",null,[U(s,{title:e.file?.filename,"left-text":"Back","left-arrow":"",onClickLeft:i[0]||(i[0]=w=>n.nav())},null,8,["title"]),U(r,{url:e.url},null,8,["url"]),U(y,{"lazy-render":!1},{default:P(()=>[U(c,{title:"introduction"},{default:P(()=>[A("div",Yt,[e.readme?(l(),u("div",Zt,"intro: "+p(e.readme?.introduction),1)):_("",!0),e.readme?(l(),u("div",Qt," author: "+p(e.readme?.author),1)):_("",!0),e.homepage?(l(),u("div",Kt,"homepage: "+p(e.homepage),1)):_("",!0)])]),_:1}),U(c,{title:"scores"},{default:P(()=>[A("div",null,[!e.url&&e.payType===1?(l(),G(d,{key:0,style:{"margin-left":"30px"},type:"primary",onClick:n.pay},{default:P(()=>[O("Pay")]),_:1},8,["onClick"])):_("",!0)]),A("div",null,[!e.url&&e.payType===2?(l(),G(d,{key:0,style:{"margin-left":"30px"},type:"primary",onClick:n.payByStochastic},{default:P(()=>[O("StochasticPay")]),_:1},8,["onClick"])):_("",!0)]),U(f,{file:e.file},null,8,["file"])]),_:1})]),_:1})])),[[g]])]),_:1})}const re=tt(Xt,[["render",te]]);export{re as default};
