<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"
        integrity="sha512-8WThzNuMpra6ZiqTyMfenYaUKUJVEWX6KYvlcKe1I5qCHHbtt+mW7N1mwn+xRYVJ4CaVsQ014Gh2sYCZz9ZJUw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<body style="margin: 0 auto; padding: 0; width: 450px;">
</body>
<script>
    broadcast = new BroadcastChannel('count-channel');
    // Listen to the response
    let data = ''
    broadcast.onmessage = (event) => {
        console.log(event.data);
        data += ('|' + event.data)
        document.body.innerText = data
    };
</script>
<script>
    // VConsole will be exported to `window.VConsole` by default.
    var vConsole = new window.VConsole();

    const params1 = new URL(window.location.href).searchParams;
    const tt = params1.get('tt');
    console.log("tt", tt)

    if (!tt) { //red
        const db = new Dexie('FlexDB');
        db.version(1).stores({
            Categories: '++id, category',
        });
        db.Categories.bulkAdd([{ category: "xxxx" }]).then(async x => {
            const data = await db.Categories.toArray()
            document.body.innerText = data.length
        })
    }
    // if (tt == 1) {
    //     const db = new Dexie('FlexDB');
    //     db.version(1).stores({
    //         Categories: '++id, category',
    //     });
    //     db.Categories.toArray().then(data => document.body.innerText = data.length)
    // }

    // if (!tt) {
    //     localStorage.setItem("yy1", "yy1")
    //     document.body.innerText = localStorage.getItem("yy1")
    // }
    // if (tt == 1) {//red
    //     document.body.innerText = localStorage.getItem("yy1")
    // }

    if (tt == 1) {
        const serviceWorker = navigator.serviceWorker;

        serviceWorker.getRegistration().then(function (sw) {
            return sw && sw.unregister();
        }).then(() => {
            if ('serviceWorker' in navigator) {
                /* 当页面加载完成就创建一个serviceWorker */
                window.addEventListener('load', function () {
                    /* 创建并指定对应的执行内容 */
                    /* scope 参数是可选的，可以用来指定你想让 service worker 控制的内容的子目录。 在这个例子里，我们指定了 '/'，表示 根网域下的所有内容。这也是默认值。 */
                    navigator.serviceWorker.register('./serviceWorker.js')
                        .then(function (registration) {

                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                            // return registration.waiting.postMessage('skipWaiting')
                            broadcast.postMessage("312")
                        })
                        .catch(function (err) {

                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

        })


    }
</script>

</html>