import{S as o}from"./Wif-c52e7263.js";class i{constructor(){this.activeHooks=new Map,this.callbacks=new Map,this.checkInterval=void 0,this.db=new o}static async instance(){return i._instance||(i._instance=new i,await i._instance.init()),i._instance}async init(){await this.db.init(),await this.evictOldHooks(),await this.pickupHooks(!0),this.checkInterval||(this.checkInterval=setInterval(async()=>{await this.evictOldHooks(),await this.pickupHooks(!0)},5*60*1e3))}async destroy(){await this.stopAll(),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=void 0)}async pickupHooks(t=!1){const a=await this.db.getWebhooks();for(const s of a)this.activeHooks.has(s.id)||(this.activeHooks.set(s.id,s),t&&await s.start())}async evictOldHooks(){const t=new Date,a=await this.db.getWebhooks();for(const s of a)t>=s.expires_at&&(this.activeHooks.has(s.id)&&await this.stopHook(s),await this.db.deleteWebhook(s.id))}async registerWebhook(t,a=!0){const s=await this.db.addWebhook(t);return a&&(this.activeHooks.set(s.id,s),await s.start()),s.id}async getWebhook(t){return this.activeHooks.has(t)?this.activeHooks.get(t):await this.db.getWebhook(t)}async deleteWebhook(t){this.activeHooks.has(t)&&await this.stopHook(this.activeHooks.get(t)),await this.db.deleteWebhook(t)}async deleteAllWebhooks(){await this.stopAll(),await this.db.clearWebhooks()}async stopAll(){for(const[,t]of this.activeHooks)await this.stopHook(t)}async stopHook(t){this.activeHooks.has(t.id)&&(await t.stop(),this.activeHooks.delete(t.id))}}export{i as W};
